<!doctype html>
<meta charset="utf-8">
<title>cesi-bot tester</title>
<style>
  body { font: 14px/1.4 system-ui, sans-serif; margin: 20px; }
  #log { height: 420px; overflow:auto; padding:12px; border:1px solid #ddd; border-radius:10px; background:#fafafa; }
  .u { color:#555; margin:6px 0; }
  .b { background:#eef9ff; padding:8px 10px; border-radius:10px; margin:6px 0; }
  .row { display:flex; gap:8px; margin-top:10px; }
  input { flex:1; padding:10px; border:1px solid #ddd; border-radius:10px; }
  button { padding:10px 14px; border:0; border-radius:10px; background:#10a37f; color:white; cursor:pointer; }
  .btn { margin-right:6px; margin-top:6px; padding:6px 10px; background:#eee; border-radius:8px; display:inline-block; cursor:pointer; }
  .cta { background:#0ea5e9; color:#fff; }
  .quick-wrap { margin-top:8px; }
  .quick-btn { padding:6px 12px; background:#f0f0f0; border:1px solid #ccc; border-radius:6px; cursor:pointer; font-size:13px; }
  pre { white-space:pre-wrap; margin:0 }
</style>
<div id="log"></div>
<div class="row">
  <input id="q" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –≤–æ–ø—Ä–æ—Å –∏ Enter‚Ä¶" />
  <button id="send">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
</div>
<script>
  const SID_KEY = 'bot_sid';
  function ensureSID(){
    let s = localStorage.getItem(SID_KEY);
    if (!s){
      s = (crypto.randomUUID ? crypto.randomUUID() : Math.random().toString(16).slice(2));
      localStorage.setItem(SID_KEY, s);
    }
    return s;
  }
  const SID = ensureSID();

const log = document.getElementById('log');
const q = document.getElementById('q');
const sid = SID;

// === –°—Ç–µ–π—Ç –¥–ª—è —Å–±–æ—Ä–∞ –∑–∞—è–≤–∫–∏ ===
let leadState = null; // null | 'need_name' | 'need_phone'
let leadDraft = { name: '', phone: '', intent: 'consultation' };
let leadAttempts = { name: 0, phone: 0 };

// === –°—á—ë—Ç—á–∏–∫–∏ –¥–ª—è —É–º–Ω–æ–≥–æ –ø–æ–∫–∞–∑–∞ CTA ===
let lastCtaAt = 0;         // –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø–æ–∫–∞–∑–∞ CTA (ms)
let lastCtaTurn = 0;       // –Ω–æ–º–µ—Ä –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è, –ø—Ä–∏ –∫–æ—Ç–æ—Ä–æ–º –ø–æ–∫–∞–∑–∞–ª–∏ CTA
let ctaShownCount = 0;     // —Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ –ø–æ–∫–∞–∑–∞–ª–∏ CTA –≤ —ç—Ç–æ–π —Å–µ—Å—Å–∏–∏
let userTurnCounter = 0;   // —Å—á—ë—Ç—á–∏–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
let lastCtaJitterMs = 0;   // —Å–ª—É—á–∞–π–Ω—ã–π –ø–æ—Ä–æ–≥ –≤—Ä–µ–º–µ–Ω–∏ –º–µ–∂–¥—É 60-90—Å

// –ö—É–ª–¥–∞—É–Ω –ø–æ—Å–ª–µ –≤—ã—Ö–æ–¥–∞ –∏–∑ –ª–∏–¥-–ø–æ—Ç–æ–∫–∞ (–Ω–µ –ø—Ä–µ–¥–ª–∞–≥–∞—Ç—å –∑–∞–ø–∏—Å—å N —Å–æ–æ–±—â–µ–Ω–∏–π)
let leadCooldownLeft = 3;  // –±—ã–ª–æ 5 ‚Äî —Å—Ç–∞–≤–∏–º 3

// –¢—ç–≥–∏ –≤—ã—Å–æ–∫–æ–π –∫–æ–Ω–≤–µ—Ä—Å–∏–∏ (–µ—Å–ª–∏ –ø—Ä–∏–¥—É—Ç –≤ resp.meta.tags)
const HIGH_INTENT_TAGS = new Set(["prices","installments","pain-fears","urgent","surgery","implants","contraindications","first-visit"]);

// –†–∞–Ω–¥–æ–º–Ω—ã–π –ø–æ—Ä–æ–≥ 60‚Äì90 —Å–µ–∫—É–Ω–¥
function nextCtaJitterMs(){
  return 60000 + Math.floor(Math.random() * 30000); // 60‚Äì90—Å
}

// === –î–µ—Ç–µ–∫—Ç–æ—Ä—ã –∏–Ω—Ç–µ–Ω—Ç–∞ ===
function detectExplicitIntent(text){
  const t = (text||"").toLowerCase();
  return /(–∑–∞–ø–∏—Å–∞—Ç|–Ω–∞ –ø—Ä–∏[–µ—ë]–º|—Ö–æ—á—É\s+–∑–∞–ø–∏—Å|–º–æ–∂–Ω–æ\s*–∑–∞–ø–∏—Å|–æ—Å—Ç–∞–≤–∏—Ç—å\s*—Ç–µ–ª|–ø–µ—Ä–µ–∑–≤–æ–Ω–∏—Ç–µ|–æ—Ñ–æ—Ä–º–∏—Ç—å\s*–∑–∞—è–≤)/iu.test(t);
}

function hasHighIntentMeta(meta){
  if (!meta) return false;
  // –ï—Å–ª–∏ –∏–∑ –±—ç–∫–∞ –ø—Ä–∏–¥—É—Ç —Ç–µ–≥–∏
  if (Array.isArray(meta.tags) && meta.tags.some(t => HIGH_INTENT_TAGS.has(String(t)))) return true;
  // –§–æ–ª–±—ç–∫ –ø–æ —Ç–µ–∫—Å—Ç–∞–º –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤, –µ—Å–ª–∏ —Ç–µ–≥–æ–≤ –Ω–µ—Ç
  const hay = ((meta.h2||"") + " " + (meta.h3||"")).toLowerCase();
  return /(—Ü–µ–Ω–∞|—Å—Ç–æ–∏–º|—Ä–∞—Å—Å—Ä–æ—á|–±–æ–ª—å–Ω–æ|—Å—Ä–æ—á–Ω|–∏–º–ø–ª–∞–Ω|—É–¥–∞–ª–µ–Ω|–æ–ø–µ—Ä–∞—Ü|–ø—Ä–æ—Ç–∏–≤–æ–ø–æ–∫–∞–∑)/iu.test(hay);
}

function ctaMode(meta){
  // –∂–¥—ë–º meta.cta_mode –∏–∑ md; –µ—Å–ª–∏ –Ω–µ—Ç ‚Äî auto
  const m = meta && meta.cta_mode ? String(meta.cta_mode).toLowerCase() : "auto";
  if (m === "always" || m === "never") return m;
  return "auto";
}

// –í—ã–∑–æ–≤ –∏–∑ CTA –¥–ª—è —Å—Ç–∞—Ä—Ç–∞ —Å—Ü–µ–Ω–∞—Ä–∏—è
function startLeadFlow(intent) {
  leadDraft = { name: '', phone: '', intent: intent || 'consultation' };
  leadState = 'need_name';
  appendBot("–î–∞–≤–∞–π—Ç–µ –∑–∞–ø–∏—à–µ–º –≤–∞—Å. –ö–∞–∫ –∫ –≤–∞–º –æ–±—Ä–∞—â–∞—Ç—å—Å—è? –¢–æ–ª—å–∫–æ –∏–º—è, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞.");
  
  // –ß—Ç–æ–±—ã –Ω–µ –¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å CTA –ø—Ä—è–º–æ –ø–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º –ª–∏–¥-–ø–æ—Ç–æ–∫–∞:
  lastCtaAt = Date.now();
  lastCtaTurn = userTurnCounter;
  
  renderLeadExitButton('–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –¥–∏–∞–ª–æ–≥');
}

function exitLeadFlow(){
  leadState = null;
  leadDraft = { name:'', phone:'', intent:'consultation' };
  leadAttempts = { name:0, phone:0 };
  setPhoneMaskMode && setPhoneMaskMode(false);
  leadCooldownLeft = 3; // –∫—É–ª–¥–∞—É–Ω: 3 —Å–æ–æ–±—â–µ–Ω–∏—è –±–µ–∑ –∞–≤—Ç–æ–ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π –∑–∞–ø–∏—Å–∏
}

function renderLeadExitButton(label){
  const wrap = document.createElement('div');
  wrap.className = 'quick-wrap';
  const b = document.createElement('button');
  b.className = 'quick-btn';
  b.textContent = label || '–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –¥–∏–∞–ª–æ–≥';
  b.onclick = () => { appendBot('–û–∫, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º. –ó–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å ‚Äî —è –ø–æ–¥—Å–∫–∞–∂—É.'); exitLeadFlow(); };
  (document.getElementById('log')||document.body).appendChild(wrap);
  wrap.appendChild(b);
}

const CANCEL_PATTERNS = /(–æ—Ç–º–µ–Ω–∞|–Ω–µ\s*—Å–µ–π—á–∞—Å|–¥–∞–≤–∞–π—Ç–µ\s*–ø–æ—Ç–æ–º|–ø–æ–∑–∂–µ|–Ω–µ —Ö–æ—á—É|–ø–µ—Ä–µ–¥—É–º–∞–ª|–±–µ–∑ –∑–∞–ø–∏—Å–∏|—Ö–æ—á—É —Å–ø—Ä–æ—Å–∏—Ç—å|–≤–æ–ø—Ä–æ—Å|–Ω–∞–∑–∞–¥|—Å—Ç–æ–ø)/iu;
function isQuestionish(q){
  const t = (q||'').toLowerCase();
  return t.includes('?') || /(–∫–∞–∫|–∫–æ–≥–¥–∞|—Å–∫–æ–ª—å–∫–æ|–≥–¥–µ|–ø–æ—á–µ–º—É|–∑–∞—á–µ–º|–º–æ–∂–Ω–æ|–Ω—É–∂–Ω–æ|–∞–¥—Ä–µ—Å|—Ü–µ–Ω–∞|—Å—Ç–æ–∏–º|–∏–º–ø–ª–∞–Ω|–∫–æ—Ä–æ–Ω–∫|–∫—Ç|–±–æ–ª—å–Ω–æ)/iu.test(t);
}
document.addEventListener('keydown', (e)=>{ if (leadState && e.key === 'Escape'){ appendBot('–û—Ç–º–µ–Ω—è—é –∑–∞–ø–∏—Å—å. –ú–æ–∂–µ–º –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –¥–∏–∞–ª–æ–≥.'); exitLeadFlow(); }});


// === –ö–∞–Ω–æ–Ω–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∏–º–µ–Ω–∏ ===
const RU_NAME_DICT = new Set([
  "–ê–Ω–Ω–∞","–ê–ª—ë–Ω–∞","–ê–ª–∏–Ω–∞","–ê–ª–∏—Å–∞","–ê–ª–µ–∫—Å–∞–Ω–¥—Ä–∞","–ê–Ω–∞—Å—Ç–∞—Å–∏—è","–ê–Ω–≥–µ–ª–∏–Ω–∞","–í–∞–ª–µ—Ä–∏—è","–í–µ—Ä–∞","–í–∏–∫—Ç–æ—Ä–∏—è","–î–∞—Ä—å—è","–î–∏–∞–Ω–∞","–ï–≤–∞","–ï–≤–≥–µ–Ω–∏—è","–ï–∫–∞—Ç–µ—Ä–∏–Ω–∞","–ï–ª–µ–Ω–∞","–ï–ª–∏–∑–∞–≤–µ—Ç–∞","–ñ–∞–Ω–Ω–∞","–ó–ª–∞—Ç–∞","–ò—Ä–∏–Ω–∞","–ö–∞—Ä–∏–Ω–∞","–ö–∏—Ä–∞","–ö—Å–µ–Ω–∏—è","–õ—é–¥–º–∏–ª–∞","–ú–∞—Ä–∏–Ω–∞","–ú–∞—Ä–∏—è","–ú–∞–π—è","–ú–∏–ª–∞–Ω–∞","–ù–∞–¥–µ–∂–¥–∞","–ù–∞—Ç–∞–ª—å—è","–û–∫—Å–∞–Ω–∞","–û–ª—å–≥–∞","–ü–æ–ª–∏–Ω–∞","–°–≤–µ—Ç–ª–∞–Ω–∞","–°–æ—Ñ–∏—è","–¢–∞–∏—Å–∏—è","–¢–∞–º–∞—Ä–∞","–¢–∞—Ç—å—è–Ω–∞","–£–ª—å—è–Ω–∞","–Æ–ª–∏—è","–Ø–Ω–∞",
  "–ê–ª–µ–∫—Å–µ–π","–ê–ª–µ–∫—Å–∞–Ω–¥—Ä","–ê–Ω–¥—Ä–µ–π","–ê–Ω—Ç–æ–Ω","–ê—Ä—Å–µ–Ω–∏–π","–ê—Ä—Ç—É—Ä","–ë–æ–≥–¥–∞–Ω","–í–∞–¥–∏–º","–í–∞–ª–µ–Ω—Ç–∏–Ω","–í–∞–ª–µ—Ä–∏–π","–í–∏–∫—Ç–æ—Ä","–í–∏—Ç–∞–ª–∏–π","–í–ª–∞–¥–∏–º–∏—Ä","–í—è—á–µ—Å–ª–∞–≤","–ì–µ–æ—Ä–≥–∏–π","–ì—Ä–∏–≥–æ—Ä–∏–π","–î–∞–Ω–∏–∏–ª","–î–µ–Ω–∏—Å","–î–º–∏—Ç—Ä–∏–π","–ï–≤–≥–µ–Ω–∏–π","–ï–≥–æ—Ä","–ò–≤–∞–Ω","–ò–≥–æ—Ä—å","–ò–ª—å—è","–ö–∏—Ä–∏–ª–ª","–ö–æ–Ω—Å—Ç–∞–Ω—Ç–∏–Ω","–õ–µ–æ–Ω–∏–¥","–õ–µ–≤","–ú–∞–∫—Å–∏–º","–ú–∞—Ä–∞—Ç","–ú–∞—Ç–≤–µ–π","–ú–∏—Ä–æ–Ω","–ú–∏—Ö–∞–∏–ª","–ù–∏–∫–∏—Ç–∞","–û–ª–µ–≥","–ü–∞–≤–µ–ª","–ü—ë—Ç—Ä","–†–æ–º–∞–Ω","–†—É—Å–ª–∞–Ω","–°–∞–≤–µ–ª–∏–π","–°–µ—Ä–≥–µ–π","–°—Ç–∞–Ω–∏—Å–ª–∞–≤","–°—Ç–µ–ø–∞–Ω","–¢–∏–º–æ—Ñ–µ–π","–§—ë–¥–æ—Ä","–Æ—Ä–∏–π","–Ø—Ä–æ—Å–ª–∞–≤"
]);

function levenshtein(a,b){
  a=a.toLowerCase(); b=b.toLowerCase();
  const m = Array.from({length:a.length+1}, (_,i)=>[i]);
  for (let j=0;j<=b.length;j++) m[0][j]=j;
  for (let i=1;i<=a.length;i++){
    for (let j=1;j<=b.length;j++){
      const cost = a[i-1]===b[j-1] ? 0 : 1;
      m[i][j] = Math.min(
        m[i-1][j]+1,      // —É–¥–∞–ª–µ–Ω–∏–µ
        m[i][j-1]+1,      // –≤—Å—Ç–∞–≤–∫–∞
        m[i-1][j-1]+cost  // –∑–∞–º–µ–Ω–∞
      );
    }
  }
  return m[a.length][b.length];
}

function isInDictOrClose(word){
  if (RU_NAME_DICT.has(word)) return true;
  // –†–∞–∑—Ä–µ—à–∏–º 1 –æ–ø–µ—á–∞—Ç–∫—É –¥–ª—è –∫–æ—Ä–æ—Ç–∫–∏—Ö (<=5), 2 ‚Äî –¥–ª—è –¥–ª–∏–Ω–Ω—ã—Ö
  const thr = word.length <= 5 ? 1 : 2;
  // –ë—ã—Å—Ç—Ä–∞—è —ç–≤—Ä–∏—Å—Ç–∏–∫–∞: —Å–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä–∏–º –ø–µ—Ä–≤—ã–µ 2 –±—É–∫–≤—ã –ø–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è–º –≤ —Å–ª–æ–≤–∞—Ä–µ
  const first2 = word.slice(0,2).toLowerCase();
  for (const n of RU_NAME_DICT){
    if (n.toLowerCase().startsWith(first2)){
      if (levenshtein(word, n) <= thr) return true;
    }
  }
  return false;
}

const RU_VOWELS = "–∞–µ—ë–∏–æ—É—ã—ç—é—è–ê–ï–Å–ò–û–£–´–≠–Æ–Ø";
const RU_LETTERS = "–∞–±–≤–≥–¥–µ—ë–∂–∑–∏–π–∫–ª–º–Ω–æ–ø—Ä—Å—Ç—É—Ñ—Ö—Ü—á—à—â—ä—å—é—è–ê–ë–í–ì–î–ï–Å–ñ–ó–ò–ô–ö–õ–ú–ù–û–ü–†–°–¢–£–§–•–¶–ß–®–©–™–¨–Æ–Ø";

function _ruOnlyNameChars(s){
  for (const ch of s){
    if (ch===' ' || ch==='-') continue;
    if (!RU_LETTERS.includes(ch)) return false;
  }
  return true;
}
function _hasVowel(s){
  for (const ch of s) if (RU_VOWELS.includes(ch)) return true;
  return false;
}
function _noTripleRepeat(s){ return !(/(.)\1\1/u.test(s)); }

function extractLikelyName(input){
  if (!input) return null;
  let t = String(input).trim();

  t = t
    .replace(/^–º–µ–Ω—è\s+–∑–æ–≤—É—Ç\s+/iu, '')
    .replace(/^—è\s*[-‚Äî:]\s*/iu, '')
    .replace(/^—ç—Ç–æ\s+/iu, '')
    .replace(/[¬´¬ª"‚Äú"]/g,'')
    .trim();

  // –°—Ç—Ä–æ–≥–æ: —Ç–æ–ª—å–∫–æ –∫–∏—Ä–∏–ª–ª–∏—Ü–∞/–ø—Ä–æ–±–µ–ª/–¥–µ—Ñ–∏—Å, –±–µ–∑ —Ü–∏—Ñ—Ä/–ª–∞—Ç–∏–Ω–∏—Ü—ã/—Å–∏–º–≤–æ–ª–æ–≤
  if (!_ruOnlyNameChars(t)) return null;
  if (!_noTripleRepeat(t)) return null;
  if (t.length < 2 || t.length > 30) return null;

  // –ú–∞–∫—Å–∏–º—É–º 2 —á–∞—Å—Ç–∏ (–∏–º—è –∏–ª–∏ –∏–º—è-—Ñ–∞–º–∏–ª–∏—è/–¥–≤–æ–π–Ω–æ–µ –∏–º—è)
  const parts = t.split(/[\s-]+/).filter(Boolean);
  if (parts.length === 0 || parts.length > 2) return null;

  // –ö–∞–∂–¥–∞—è —á–∞—Å—Ç—å –æ–∫ –ø–æ –¥–ª–∏–Ω–µ, –∏–º–µ–µ—Ç –≥–ª–∞—Å–Ω—É—é, –∏ –ø—Ä–æ—Ö–æ–¥–∏—Ç —Å–ª–æ–≤–∞—Ä—å/–±–ª–∏–∑–æ—Å—Ç—å
  for (let p of parts){
    if (p.length < 2 || p.length > 15) return null;
    if (!_hasVowel(p)) return null;

    // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º —Ä–µ–≥–∏—Å—Ç—Ä –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤ —Å–ª–æ–≤–∞—Ä–µ
    p = p[0].toUpperCase() + p.slice(1).toLowerCase();
    if (!(RU_NAME_DICT.has(p) || isInDictOrClose(p))) return null;
  }

  // –°–æ–±–∏—Ä–∞–µ–º –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ –∏–º—è (Title Case)
  const norm = parts.map(p => p[0].toUpperCase() + p.slice(1).toLowerCase()).join(' ');
  return norm;
}

function isValidName(s){ return !!extractLikelyName(s); }

// === –ú–∞—Å–∫–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ ===
const inputEl = document.getElementById('q');

function digitsOnly(s){ return (s || '').replace(/\D+/g,''); }

// –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –∫ 11 —Ü–∏—Ñ—Ä–∞–º –†–§, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç—Ä–æ–∫—É –∏–∑ 11 —Ü–∏—Ñ—Ä, –≥–¥–µ –ø–µ—Ä–≤–∞—è ‚Äî '7', –ª–∏–±–æ null
function normalizeRuDigits(raw){
  let d = digitsOnly(raw);
  if (!d) return null;
  // –ï—Å–ª–∏ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å 8 ‚Äî –∑–∞–º–µ–Ω—è–µ–º –Ω–∞ 7
  if (d.length === 11 && d[0] === '8') d = '7' + d.slice(1);
  // –ï—Å–ª–∏ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å 9 –∏ –¥–ª–∏–Ω–∞ 10 ‚Äî –¥–æ–±–∞–≤–∏–º 7
  if (d.length === 10 && d[0] === '9') d = '7' + d;
  // –ï—Å–ª–∏ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å 7 –∏ –¥–ª–∏–Ω–∞ 11 ‚Äî –æ–∫
  if (d.length === 12 && d.startsWith('07')) d = d.slice(1); // –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π
  if (d.length !== 11 || d[0] !== '7') return null;
  return d;
}

// –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –≤ +7(XXX)XXX-XX-XX
function formatRuMask(d11){
  const d = d11;
  return `+7(${d.slice(1,4)})${d.slice(4,7)}-${d.slice(7,9)}-${d.slice(9,11)}`;
}

// –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–µ–∂–∏–º–æ–º –º–∞—Å–∫–∏
let maskHandlersAttached = false;

function setPhoneMaskMode(on){
  if (!inputEl) return;
  if (on && !maskHandlersAttached){
    inputEl.placeholder = '+7(900)000-00-00';
    inputEl.maxLength = 18; // –¥–ª–∏–Ω–∞ –º–∞—Å–∫–∏
    inputEl.addEventListener('input', onPhoneInput);
    inputEl.addEventListener('paste', onPhonePaste);
    maskHandlersAttached = true;
    // –ï—Å–ª–∏ —Å–µ–π—á–∞—Å –ø—É—Å—Ç–æ ‚Äî –ø–æ–¥—Å—Ç–∞–≤–∏–º +7(
    if (!inputEl.value) inputEl.value = '+7(';
    // –∫—É—Ä—Å–æ—Ä –≤ –∫–æ–Ω–µ—Ü
    requestAnimationFrame(()=> inputEl.setSelectionRange(inputEl.value.length, inputEl.value.length));
  } else if (!on && maskHandlersAttached){
    inputEl.removeEventListener('input', onPhoneInput);
    inputEl.removeEventListener('paste', onPhonePaste);
    inputEl.placeholder = '';
    inputEl.maxLength = 500;
    maskHandlersAttached = false;
  }
}

function onPhonePaste(e){
  e.preventDefault();
  const txt = (e.clipboardData || window.clipboardData).getData('text');
  const d = normalizeRuDigits(txt);
  if (d){
    inputEl.value = formatRuMask(d);
  } else {
    // –≤—Å—Ç–∞–≤–∏–º —Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã –∏–∑ –±—É—Ñ–µ—Ä–∞ –≤ —Ç–µ–∫—É—â—É—é –º–∞—Å–∫—É
    const merged = digitsOnly(inputEl.value + txt);
    const fallback = normalizeRuDigits(merged);
    inputEl.value = fallback ? formatRuMask(fallback) : '+7(';
  }
  requestAnimationFrame(()=> inputEl.setSelectionRange(inputEl.value.length, inputEl.value.length));
}

function onPhoneInput(e){
  const raw = inputEl.value;
  // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ —Ü–∏—Ñ—Ä—ã, –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ–º
  let d = digitsOnly(raw);
  // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞—á–∞–ª –Ω–µ —Å +7 ‚Äî –ø–æ–º–æ–≥–∞–µ–º
  if (d.startsWith('8') && d.length <= 11) d = '7' + d.slice(1);
  if (d.startsWith('9') && d.length <= 10) d = '7' + d;
  // –û–±—Ä–µ–∂–µ–º –¥–æ 11
  if (d.length > 11) d = d.slice(0,11);

  if (d.length === 0){
    inputEl.value = '+7(';
    return;
  }
  if (d[0] !== '7'){
    d = '7' + d.replace(/^./,'');
  }
  // –ß–∞—Å—Ç–∏—á–Ω–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ –º–µ—Ä–µ –≤–≤–æ–¥–∞
  let out = '+7(';
  if (d.length >= 2) out += d.slice(1,4);
  if (d.length >= 4) out += ')';
  if (d.length >= 5) out += d.slice(4,7);
  if (d.length >= 7) out += '-';
  if (d.length >= 8) out += d.slice(7,9);
  if (d.length >= 9) out += '-';
  if (d.length >= 10) out += d.slice(9,11);
  inputEl.value = out;
}

function pickFinalPhone(){
  const d = normalizeRuDigits(inputEl.value);
  return d ? ('+' + d) : null;
}

// –ö–∞–º—á–∞—Ç–∫–∞: –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—á–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏
function clinicOpenInfo() {
  const parts = new Intl.DateTimeFormat('ru-RU', {
    timeZone: 'Asia/Kamchatka',
    weekday: 'short', hour: '2-digit', minute: '2-digit', hour12: false
  }).formatToParts(new Date());
  const map = Object.fromEntries(parts.map(p => [p.type, p.value]));
  const wd = (map.weekday || '').toLowerCase();   // '–ø–Ω','–≤—Ç','—Å—Ä','—á—Ç','–ø—Ç','—Å–±','–≤—Å'
  const hour = Number(map.hour || 0);
  const minute = Number(map.minute || 0);
  const t = hour + minute/60;

  const isSun = wd.startsWith('–≤—Å');
  const isSat = wd.startsWith('—Å–±');
  let open = false, next = null;
  if (isSun) {
    open = false; next = '–ü–Ω —Å 08:00 (–ö–∞–º—á–∞—Ç–∫–∞)';
  } else if (isSat) {
    open = (t >= 8 && t < 14);
    next = t < 8 ? '–°–µ–≥–æ–¥–Ω—è —Å 08:00 (–ö–∞–º—á–∞—Ç–∫–∞)' : (!open ? '–ü–Ω —Å 08:00 (–ö–∞–º—á–∞—Ç–∫–∞)' : null);
  } else {
    open = (t >= 8 && t < 20);
    next = t < 8 ? '–°–µ–≥–æ–¥–Ω—è —Å 08:00 (–ö–∞–º—á–∞—Ç–∫–∞)' : (!open ? '–ó–∞–≤—Ç—Ä–∞ —Å 08:00 (–ö–∞–º—á–∞—Ç–∫–∞)' : null);
  }
  return { open, next };
}

// –•–µ–ª–ø–µ—Ä—ã –¥–ª—è –≤—ã–≤–æ–¥–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞/–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
function appendBot(text) { add(`<pre>${text}</pre>`, 'b'); }
function appendUser(text) { add(`<pre>${text}</pre>`, 'u'); }

function add(html, cls='') {
  const d = document.createElement('div');
  d.className = cls;
  d.innerHTML = html;
  log.appendChild(d);
  log.scrollTop = log.scrollHeight;
}

function pick(obj, keys, def='') {
  for (const k of keys) {
    const v = k.split('.').reduce((o, p) => (o && o[p] !== undefined ? o[p] : undefined), obj);
    if (v !== undefined && v !== null && String(v).trim() !== '') return v;
  }
  return def;
}

function renderAnswerBlock(data, rawText){
  const meta = (data && data.meta) || {};
  const answer = (data && typeof data.answer === 'string' && data.answer.trim()) ? data.answer : null;

  let html = '';
  if (answer) {
    html += `<div><strong>–û—Ç–≤–µ—Ç:</strong> ${answer}</div>`;
  } else {
    html += `<div><strong>–û—Ç–≤–µ—Ç:</strong> (–æ—à–∏–±–∫–∞)</div>`;
    html += `<div style="font-size:12px;color:#a00;margin-top:4px;">–ë—ç–∫–µ–Ω–¥ –≤–µ—Ä–Ω—É–ª –ø—É—Å—Ç–æ–π –∏–ª–∏ –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π –æ—Ç–≤–µ—Ç.</div>`;
  }
  if (meta.file) {
    html += `<div style="font-size:12px;color:#666;margin-top:4px;">–ò—Å—Ç–æ—á–Ω–∏–∫: ${meta.file}${meta.h2?' ‚Üí '+meta.h2:''}${meta.h3?' ‚Üí '+meta.h3:''}${meta.score!==undefined?' (score: '+meta.score+')':''}</div>`;
  }
  const safe = String(rawText||'').replace(/[<>&]/g, s=>({ '<':'&lt;','>':'&gt;','&':'&amp;' }[s]));
  html += `<div style="margin-top:8px"><a href="#" onclick="this.nextSibling.style.display='block';this.remove();return false;">–ü–æ–∫–∞–∑–∞—Ç—å JSON</a><pre style="display:none">${safe}</pre></div>`;

  add(html,'b');
  const lastMsgEl = log && log.lastElementChild;
  if (lastMsgEl && data) renderUx(lastMsgEl, data);
  if (lastMsgEl && data && data.cta) maybeRenderCta(lastMsgEl, data, '');
  if (lastMsgEl && data) renderMemoryButton(lastMsgEl, data);
}

async function ask(text) {
  let raw = ''; let data = null; let ok = false;
  try {
  const r = await fetch('/ask', {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ q: text, sid: SID })
    });
    raw = await r.text();
    try { data = JSON.parse(raw); ok = r.ok; } catch(e){ data = null; }
  } catch(e) {
    raw = String(e);
  }

  renderAnswerBlock(data, raw);
  
  return data || { raw, ok };
}

// === –£–º–Ω—ã–π –ø–æ–∫–∞–∑ CTA ===
function maybeRenderCta(containerEl, resp, latestUserText){
  // –ü—Ä–µ–¥–ø–æ—Å—ã–ª–∫–∏
  if (!resp || !resp.cta) return;
  if (leadState) return;                // –≤ –ª–∏–¥-–ø–æ—Ç–æ–∫–µ –∫–Ω–æ–ø–∫—É –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º
  if (leadCooldownLeft > 0) return;     // –∫—É–ª–¥–∞—É–Ω –ø–æ—Å–ª–µ –æ—Ç–∫–∞–∑–∞
  if (!containerEl) return;

  const mode = ctaMode(resp.meta);
  if (mode === "never") return;

  const now = Date.now();
  const timePassed = now - (lastCtaAt || 0);
  if (!lastCtaJitterMs) lastCtaJitterMs = nextCtaJitterMs();

  // –ü—Ä–∞–≤–∏–ª–∞ –ø–æ–∫–∞–∑–∞
  const explicit = detectExplicitIntent(latestUserText);
  const hiIntent = hasHighIntentMeta(resp.meta);
  const timeOk   = timePassed >= lastCtaJitterMs && (userTurnCounter - lastCtaTurn) >= 2;
  const limitOk  = (ctaShownCount < 3) || (mode === "always"); // –æ–≥—Ä–∞–Ω–∏—á–∏–º –æ–±—â–µ–µ —á–∏—Å–ª–æ –ø–æ–∫–∞–∑–æ–≤

  let show = false;
  if (mode === "always") show = true;
  else if (explicit)     show = true;
  else if (hiIntent)     show = true;
  else if (timeOk && limitOk) show = true;

  if (!show) return;

  // –†–µ–Ω–¥–µ—Ä –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–π CTA-–∫–Ω–æ–ø–∫–∏
  const btn = document.createElement('button');
  btn.className = 'cta-btn';
  btn.textContent = resp.cta.text || '–ó–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é';
  btn.onclick = () => {
    const intent = resp.cta.action || 'consultation';
    startLeadFlow(intent);         // –≤–∞—à —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Å—Ç–∞—Ä—Ç –∏–Ω–ª–∞–π–Ω-–∑–∞—è–≤–∫–∏
  };
  containerEl.appendChild(btn);

  // –û–±–Ω–æ–≤–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏ –ø–æ–∫–∞–∑–∞
  lastCtaAt = now;
  lastCtaTurn = userTurnCounter;
  ctaShownCount += 1;
  lastCtaJitterMs = nextCtaJitterMs(); // –∑–∞–Ω–æ–≤–æ –±—Ä–æ—Å–∏–º –ø–æ—Ä–æ–≥
}

// –§—É–Ω–∫—Ü–∏—è —Ä–µ–Ω–¥–µ—Ä–∞ UX-—ç–ª–µ–º–µ–Ω—Ç–æ–≤ (–±—ã—Å—Ç—Ä—ã–µ —Å—Å—ã–ª–∫–∏)
function renderUx(containerEl, resp){
  if (!containerEl || !resp) return;

  const meta = resp.meta || {};
  const isOverview = !!meta.is_overview;

  // followups –ø—Ä–∏—Ö–æ–¥–∏—Ç —É–∂–µ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–π (–¥–ª—è overview)
  let followups = Array.isArray(meta.followups) ? meta.followups : [];
  let quickRefs = Array.isArray(resp.quick_replies) ? resp.quick_replies : [];

  // –î–µ–¥—É–ø –ø–æ label/ref, –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç —É quickRefs
  const labelsInRefs = new Set(quickRefs.map(x => (x.label||'').toLowerCase()));
  followups = followups.filter(x => !labelsInRefs.has((x.label||'').toLowerCase()));

  // –í—ã–±–∏—Ä–∞–µ–º —Ä–æ–≤–Ω–æ 2 –∫–Ω–æ–ø–∫–∏:
  let buttons = [];
  if (isOverview && followups.length > 0) {
    buttons.push(followups[0]);         // 1 followup
    if (quickRefs.length > 0) buttons.push(quickRefs[0]); // + 1 ref
  } else {
    // –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π —Ä–∞–∑–¥–µ–ª –∏–ª–∏ –æ–¥–Ω–æ—á–∞–Ω–∫–æ–≤—ã–π —Ñ–∞–π–ª: –¥–æ 2 refs
    buttons = quickRefs.slice(0, 2);
  }
  
  // –î–µ–¥—É–ø –ø–æ ref/label
  const seen = new Set();
  buttons = buttons.filter(b => {
    const key = (b.ref || b.label || '').toLowerCase();
    if (!key || seen.has(key)) return false;
    seen.add(key);
    return true;
  });

  // –†–µ–Ω–¥–µ—Ä
  if (buttons.length){
    const wrap = document.createElement('div');
    wrap.className = 'quick-wrap';
    for (const b of buttons){
      const el = document.createElement('span');
      el.className = 'btn';
      el.textContent = b.label || '–ü–æ–¥—Ä–æ–±–Ω–µ–µ';
      el.onclick = () => {
        if (b.ref) sendRef(b.ref); else if (b.query) sendQuestion(b.query);
      };
      wrap.appendChild(el);
    }
    containerEl.appendChild(wrap);
  }
}

// –§—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–æ ref
async function sendRef(ref){
  try{
    const r = await fetch('/ask', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ ref, sid: SID })
    });
  const raw = await r.text();
    let data = null;
    try { data = JSON.parse(raw); } catch(e){ data = { answer: '(–æ—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON)', meta:{}, raw }; }
    renderAnswerBlock(data, raw);
  } catch(e){
    appendBot('(—Å–µ—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞)');
  }
}

// –§—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤–æ–ø—Ä–æ—Å–∞ —Å –ø–µ—Ä–µ—Ö–≤–∞—Ç–æ–º leadState
async function sendQuestion(text) {
  const q = (text || '').trim();
  if (!q) return;
  if (leadCooldownLeft > 0) leadCooldownLeft--; // —Ç–∏–∫ –∫—É–ª–¥–∞—É–Ω–∞

  if (leadState && (CANCEL_PATTERNS.test(q) || isQuestionish(q))) {
    appendUser(q);
    appendBot('–•–æ—Ä–æ—à–æ, –≤—ã—Ö–æ–∂—É –∏–∑ –∑–∞–ø–∏—Å–∏. –°–ª—É—à–∞—é –≤–∞—à –≤–æ–ø—Ä–æ—Å üôÇ');
    exitLeadFlow();
    // –Ω–µ –¥–µ–ª–∞–µ–º return ‚Äî –Ω–∏–∂–µ –ø–æ–π–¥—ë—Ç –æ–±—ã—á–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ /ask
  }

  // —É—á—ë—Ç —Ö–æ–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  userTurnCounter += 1;

  // –°–±—Ä–æ—Å –º–∞—Å–∫–∏ –ø—Ä–∏ –æ–±—ã—á–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–∞—Ö
  if (!leadState) setPhoneMaskMode(false);

  // –ï—Å–ª–∏ –∏–¥—ë—Ç —Å–±–æ—Ä –ª–∏–¥–∞ ‚Äî –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è
  if (leadState === 'need_name') {
    appendUser(q);
    const nameNorm = extractLikelyName(q);
    leadAttempts.name++;
    if (!nameNorm) {
      appendBot('–ù—É–∂–Ω–æ —Ç–æ–ª—å–∫–æ –∏–º—è –∫–∏—Ä–∏–ª–ª–∏—Ü–µ–π, –Ω–∞–ø—Ä–∏–º–µ—Ä: ¬´–ê–Ω–Ω–∞¬ª, ¬´–ï–≥–æ—Ä¬ª, ¬´–ê–Ω–Ω–∞-–ú–∞—Ä–∏—è¬ª. –ï—Å–ª–∏ —É–¥–æ–±–Ω–æ ‚Äî –Ω–∞–ø–∏—à–∏—Ç–µ ¬´–ú–µ–Ω—è –∑–æ–≤—É—Ç –ê–Ω–Ω–∞¬ª.');
      if (leadAttempts.name >= 1) renderLeadExitButton('–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –¥–∏–∞–ª–æ–≥');
      if (inputEl) inputEl.focus();
      return;
    }
    leadAttempts.name = 0;
    leadDraft.name = nameNorm;
    leadState = 'need_phone';
    appendBot(`–ü—Ä–∏—è—Ç–Ω–æ –ø–æ–∑–Ω–∞–∫–æ–º–∏—Ç—å—Å—è, ${leadDraft.name}! –£–∫–∞–∂–∏—Ç–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞. –ú–æ–∂–Ω–æ –≤ –ª—é–±–æ–º –≤–∏–¥–µ ‚Äî —è —Å–∞–º –ø—Ä–∏–≤–µ–¥—É –∫ —Ñ–æ—Ä–º–∞—Ç—É.`);
    setPhoneMaskMode(true);
    if (inputEl) { inputEl.value = '+7('; inputEl.focus(); }
    return;
  }

  if (leadState === 'need_phone') {
    appendUser(q);
    const phone = pickFinalPhone();
    leadAttempts.phone++;
    if (!phone) {
      appendBot('–ù–µ –ø–æ—Ö–æ–∂–µ –Ω–∞ –Ω–æ–º–µ—Ä. –í–≤–µ–¥–∏—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω –≤ —Ñ–æ—Ä–º–∞—Ç–µ +7(900)000-00-00 ‚Äî —è –ø–æ–º–æ–≥—É.');
      if (leadAttempts.phone >= 1) renderLeadExitButton('–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –¥–∏–∞–ª–æ–≥');
      if (inputEl) inputEl.focus();
      return;
    }
    leadAttempts.phone = 0;

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—á–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏
    const info = clinicOpenInfo();

    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞—è–≤–∫—É
    try {
      const res = await fetch('/lead', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ name: leadDraft.name, phone: phone, intent: leadDraft.intent })
      });
      const j = await res.json();
      if (j.ok) {
        appendBot(info.open
          ? `–°–ø–∞—Å–∏–±–æ! –ó–∞—è–≤–∫–∞ –ø—Ä–∏–Ω—è—Ç–∞. –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —Å–≤—è–∂–µ—Ç—Å—è —Å –≤–∞–º–∏ –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è.`
          : `–°–ø–∞—Å–∏–±–æ! –ó–∞—è–≤–∫–∞ –ø—Ä–∏–Ω—è—Ç–∞. –°–µ–π—á–∞—Å –∫–ª–∏–Ω–∏–∫–∞ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç. –ú—ã –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø–µ—Ä–µ–∑–≤–æ–Ω–∏–º –≤ —Ä–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è (${info.next}).`);
      } else {
        appendBot('–ù–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–æ–º–µ—Ä –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.');
        if (inputEl) inputEl.focus();
        return;
      }
    } catch(e) {
      appendBot('–°–µ—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑ –ø–æ–∑–∂–µ.');
      return;
    } finally {
      // –°–±—Ä–æ—Å
      exitLeadFlow();
    }
    return;
  }

  // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã "–∑–∞–ø–∏—Å–∞—Ç—å—Å—è" –±–µ–∑ –∫–Ω–æ–ø–∫–∏
  if (!leadState && detectExplicitIntent(q)) { 
    startLeadFlow('consultation'); 
    return; 
  }

  // –û–±—ã—á–Ω—ã–π —Ä–µ–∂–∏–º: –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤–æ–ø—Ä–æ—Å –Ω–∞ –±—ç–∫
  appendUser(q);
  const resp = await ask(q);
  
  // –£–º–Ω—ã–π –ø–æ–∫–∞–∑ CTA –ø–æ—Å–ª–µ –æ—Ç–≤–µ—Ç–∞
  if (resp && resp.cta) {
    const lastMsgEl = log.lastElementChild; // –ø–æ—Å–ª–µ–¥–Ω–∏–π –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç
    maybeRenderCta(lastMsgEl, resp, q);
  }
}

function renderMemoryButton(containerEl, resp){
  const sid = (resp.meta && resp.meta.sid) || null;
  if (!sid) return;
  const btn = document.createElement('a');
  btn.href = '#'; btn.style.marginLeft = '12px';
  btn.textContent = '–ü–∞–º—è—Ç—å';
  btn.onclick = async (e)=>{
    e.preventDefault();
    try{
      const r = await fetch(`/static/sessions/${sid}.json`);
      const t = await r.text();
      const pre = document.createElement('pre');
      pre.textContent = t;
      containerEl.appendChild(pre);
    }catch(e){}
  };
  const links = containerEl.querySelector('div a');
  if (links && links.parentNode) links.parentNode.appendChild(btn);
}

document.getElementById('send').onclick = () => {
  if(q.value.trim()) { sendQuestion(q.value.trim()); q.value=''; q.focus(); }
};
q.addEventListener('keydown', e => { if(e.key==='Enter'){ e.preventDefault(); document.getElementById('send').click(); }});
add('–ì–æ—Ç–æ–≤! –ó–∞–¥–∞–π –≤–æ–ø—Ä–æ—Å‚Ä¶','b');
</script>
